name: 2. Build & Deploy to GCP

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    # Só roda se o PR foi mergeado (aprovado)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: us-central1
      REPO_NAME: meu-repo-docker 

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. Autenticação na GCP
      - name: Google Auth
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      # 2. Configura o GCloud CLI
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v1'

      # 3. Autentica o Docker
      - name: Docker Auth
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 4. Build e Push da Imagem (Aqui ele usa o Dockerfile e requirements.txt)
      - name: Build and Push Container
        run: |
          TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/app:${{ github.sha }}"
          echo "Construindo imagem: $TAG"
          docker build -t $TAG .
          docker push $TAG
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

      # 5. Instala o Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      # 6. Aplica a Infraestrutura
      - name: Terraform Deploy
        working-directory: ./terraform
        run: |
          terraform init
          terraform apply -auto-approve \
            -var="project_id=${{ env.PROJECT_ID }}" \
            -var="docker_image=${{ env.IMAGE_TAG }}"